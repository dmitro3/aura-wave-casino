-- ===============================================
-- FIX LEVEL REQUIREMENTS SYSTEM
-- ===============================================
-- This fixes the broken level calculation system where users could never level up
-- due to constantly moving XP requirements. Now uses fixed requirements.

-- Step 1: Create the correct level calculation function
-- ===================================================

DROP FUNCTION IF EXISTS public.calculate_level_from_xp_new(integer) CASCADE;

CREATE OR REPLACE FUNCTION public.calculate_level_from_xp_new(total_xp integer)
RETURNS TABLE(level integer, current_level_xp integer, xp_to_next integer)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    level_requirements integer[] := ARRAY[
        651, 651, 651, 651, 651, 651, 651, 651, 651, 651,  -- Levels 1-10
        678, 678, 678, 678, 678, 678, 678, 678, 678, 678,  -- Levels 11-20
        707, 707, 707, 707, 707, 707, 707, 707, 707, 707,  -- Levels 21-30
        738, 738, 738, 738, 738, 738, 738, 738, 738, 738,  -- Levels 31-40
        770, 770, 770, 770, 770, 770, 770, 770, 770, 770,  -- Levels 41-50
        803, 803, 803, 803, 803, 803, 803, 803, 803, 803,  -- Levels 51-60
        837, 837, 837, 837, 837, 837, 837, 837, 837, 837,  -- Levels 61-70
        874, 874, 874, 874, 874, 874, 874, 874, 874, 874,  -- Levels 71-80
        911, 911, 911, 911, 911, 911, 911, 911, 911, 911,  -- Levels 81-90
        950, 950, 950, 950, 950, 950, 950, 950, 950, 950,  -- Levels 91-100
        992, 992, 992, 992, 992, 992, 992, 992, 992, 992,  -- Levels 101-110
        1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034,  -- Levels 111-120
        1078, 1078, 1078, 1078, 1078, 1078, 1078, 1078, 1078, 1078,  -- Levels 121-130
        1124, 1124, 1124, 1124, 1124, 1124, 1124, 1124, 1124, 1124,  -- Levels 131-140
        1173, 1173, 1173, 1173, 1173, 1173, 1173, 1173, 1173, 1173,  -- Levels 141-150
        1224, 1224, 1224, 1224, 1224, 1224, 1224, 1224, 1224, 1224,  -- Levels 151-160
        1276, 1276, 1276, 1276, 1276, 1276, 1276, 1276, 1276, 1276,  -- Levels 161-170
        1331, 1331, 1331, 1331, 1331, 1331, 1331, 1331, 1331, 1331,  -- Levels 171-180
        1388, 1388, 1388, 1388, 1388, 1388, 1388, 1388, 1388, 1388,  -- Levels 181-190
        1448, 1448, 1448, 1448, 1448, 1448, 1448, 1448, 1448, 1448,  -- Levels 191-200
        1510, 1510, 1510, 1510, 1510, 1510, 1510, 1510, 1510, 1510,  -- Levels 201-210
        1576, 1576, 1576, 1576, 1576, 1576, 1576, 1576, 1576, 1576,  -- Levels 211-220
        1643, 1643, 1643, 1643, 1643, 1643, 1643, 1643, 1643, 1643,  -- Levels 221-230
        1713, 1713, 1713, 1713, 1713, 1713, 1713, 1713, 1713, 1713,  -- Levels 231-240
        1787, 1787, 1787, 1787, 1787, 1787, 1787, 1787, 1787, 1787,  -- Levels 241-250
        1864, 1864, 1864, 1864, 1864, 1864, 1864, 1864, 1864, 1864,  -- Levels 251-260
        1944, 1944, 1944, 1944, 1944, 1944, 1944, 1944, 1944, 1944,  -- Levels 261-270
        2028, 2028, 2028, 2028, 2028, 2028, 2028, 2028, 2028, 2028,  -- Levels 271-280
        2115, 2115, 2115, 2115, 2115, 2115, 2115, 2115, 2115, 2115,  -- Levels 281-290
        2206, 2206, 2206, 2206, 2206, 2206, 2206, 2206, 2206, 2206,  -- Levels 291-300
        2301, 2301, 2301, 2301, 2301, 2301, 2301, 2301, 2301, 2301,  -- Levels 301-310
        2399, 2399, 2399, 2399, 2399, 2399, 2399, 2399, 2399, 2399,  -- Levels 311-320
        2503, 2503, 2503, 2503, 2503, 2503, 2503, 2503, 2503, 2503,  -- Levels 321-330
        2610, 2610, 2610, 2610, 2610, 2610, 2610, 2610, 2610, 2610,  -- Levels 331-340
        2723, 2723, 2723, 2723, 2723, 2723, 2723, 2723, 2723, 2723,  -- Levels 341-350
        2840, 2840, 2840, 2840, 2840, 2840, 2840, 2840, 2840, 2840,  -- Levels 351-360
        2962, 2962, 2962, 2962, 2962, 2962, 2962, 2962, 2962, 2962,  -- Levels 361-370
        3089, 3089, 3089, 3089, 3089, 3089, 3089, 3089, 3089, 3089,  -- Levels 371-380
        3222, 3222, 3222, 3222, 3222, 3222, 3222, 3222, 3222, 3222,  -- Levels 381-390
        3361, 3361, 3361, 3361, 3361, 3361, 3361, 3361, 3361, 3361,  -- Levels 391-400
        3505, 3505, 3505, 3505, 3505, 3505, 3505, 3505, 3505, 3505,  -- Levels 401-410
        3656, 3656, 3656, 3656, 3656, 3656, 3656, 3656, 3656, 3656,  -- Levels 411-420
        3813, 3813, 3813, 3813, 3813, 3813, 3813, 3813, 3813, 3813,  -- Levels 421-430
        3977, 3977, 3977, 3977, 3977, 3977, 3977, 3977, 3977, 3977,  -- Levels 431-440
        4148, 4148, 4148, 4148, 4148, 4148, 4148, 4148, 4148, 4148,  -- Levels 441-450
        4327, 4327, 4327, 4327, 4327, 4327, 4327, 4327, 4327, 4327,  -- Levels 451-460
        4513, 4513, 4513, 4513, 4513, 4513, 4513, 4513, 4513, 4513,  -- Levels 461-470
        4707, 4707, 4707, 4707, 4707, 4707, 4707, 4707, 4707, 4707,  -- Levels 471-480
        4909, 4909, 4909, 4909, 4909, 4909, 4909, 4909, 4909, 4909,  -- Levels 481-490
        5120, 5120, 5120, 5120, 5120, 5120, 5120, 5120, 5120, 5120,  -- Levels 491-500
        5340, 5340, 5340, 5340, 5340, 5340, 5340, 5340, 5340, 5340,  -- Levels 501-510
        5570, 5570, 5570, 5570, 5570, 5570, 5570, 5570, 5570, 5570,  -- Levels 511-520
        5810, 5810, 5810, 5810, 5810, 5810, 5810, 5810, 5810, 5810,  -- Levels 521-530
        6059, 6059, 6059, 6059, 6059, 6059, 6059, 6059, 6059, 6059,  -- Levels 531-540
        6320, 6320, 6320, 6320, 6320, 6320, 6320, 6320, 6320, 6320,  -- Levels 541-550
        6592, 6592, 6592, 6592, 6592, 6592, 6592, 6592, 6592, 6592,  -- Levels 551-560
        6875, 6875, 6875, 6875, 6875, 6875, 6875, 6875, 6875, 6875,  -- Levels 561-570
        7171, 7171, 7171, 7171, 7171, 7171, 7171, 7171, 7171, 7171,  -- Levels 571-580
        7479, 7479, 7479, 7479, 7479, 7479, 7479, 7479, 7479, 7479,  -- Levels 581-590
        7801, 7801, 7801, 7801, 7801, 7801, 7801, 7801, 7801, 7801,  -- Levels 591-600
        8136, 8136, 8136, 8136, 8136, 8136, 8136, 8136, 8136, 8136,  -- Levels 601-610
        8486, 8486, 8486, 8486, 8486, 8486, 8486, 8486, 8486, 8486,  -- Levels 611-620
        8851, 8851, 8851, 8851, 8851, 8851, 8851, 8851, 8851, 8851,  -- Levels 621-630
        9231, 9231, 9231, 9231, 9231, 9231, 9231, 9231, 9231, 9231,  -- Levels 631-640
        9628, 9628, 9628, 9628, 9628, 9628, 9628, 9628, 9628, 9628,  -- Levels 641-650
        10043, 10043, 10043, 10043, 10043, 10043, 10043, 10043, 10043, 10043,  -- Levels 651-660
        10475, 10475, 10475, 10475, 10475, 10475, 10475, 10475, 10475, 10475,  -- Levels 661-670
        10925, 10925, 10925, 10925, 10925, 10925, 10925, 10925, 10925, 10925,  -- Levels 671-680
        11394, 11394, 11394, 11394, 11394, 11394, 11394, 11394, 11394, 11394,  -- Levels 681-690
        11885, 11885, 11885, 11885, 11885, 11885, 11885, 11885, 11885, 11885,  -- Levels 691-700
        12395, 12395, 12395, 12395, 12395, 12395, 12395, 12395, 12395, 12395,  -- Levels 701-710
        12928, 12928, 12928, 12928, 12928, 12928, 12928, 12928, 12928, 12928,  -- Levels 711-720
        13484, 13484, 13484, 13484, 13484, 13484, 13484, 13484, 13484, 13484,  -- Levels 721-730
        14064, 14064, 14064, 14064, 14064, 14064, 14064, 14064, 14064, 14064,  -- Levels 731-740
        14669, 14669, 14669, 14669, 14669, 14669, 14669, 14669, 14669, 14669,  -- Levels 741-750
        15300, 15300, 15300, 15300, 15300, 15300, 15300, 15300, 15300, 15300,  -- Levels 751-760
        15958, 15958, 15958, 15958, 15958, 15958, 15958, 15958, 15958, 15958,  -- Levels 761-770
        16644, 16644, 16644, 16644, 16644, 16644, 16644, 16644, 16644, 16644,  -- Levels 771-780
        17359, 17359, 17359, 17359, 17359, 17359, 17359, 17359, 17359, 17359,  -- Levels 781-790
        18106, 18106, 18106, 18106, 18106, 18106, 18106, 18106, 18106, 18106,  -- Levels 791-800
        18884, 18884, 18884, 18884, 18884, 18884, 18884, 18884, 18884, 18884,  -- Levels 801-810
        19696, 19696, 19696, 19696, 19696, 19696, 19696, 19696, 19696, 19696,  -- Levels 811-820
        20543, 20543, 20543, 20543, 20543, 20543, 20543, 20543, 20543, 20543,  -- Levels 821-830
        21426, 21426, 21426, 21426, 21426, 21426, 21426, 21426, 21426, 21426,  -- Levels 831-840
        22348, 22348, 22348, 22348, 22348, 22348, 22348, 22348, 22348, 22348,  -- Levels 841-850
        23309, 23309, 23309, 23309, 23309, 23309, 23309, 23309, 23309, 23309,  -- Levels 851-860
        24311, 24311, 24311, 24311, 24311, 24311, 24311, 24311, 24311, 24311,  -- Levels 861-870
        25357, 25357, 25357, 25357, 25357, 25357, 25357, 25357, 25357, 25357,  -- Levels 871-880
        26447, 26447, 26447, 26447, 26447, 26447, 26447, 26447, 26447, 26447,  -- Levels 881-890
        27584, 27584, 27584, 27584, 27584, 27584, 27584, 27584, 27584, 27584,  -- Levels 891-900
        28770, 28770, 28770, 28770, 28770, 28770, 28770, 28770, 28770, 28770,  -- Levels 901-910
        30007, 30007, 30007, 30007, 30007, 30007, 30007, 30007, 30007, 30007,  -- Levels 911-920
        31298, 31298, 31298, 31298, 31298, 31298, 31298, 31298, 31298, 31298,  -- Levels 921-930
        32643, 32643, 32643, 32643, 32643, 32643, 32643, 32643, 32643, 32643,  -- Levels 931-940
        34047, 34047, 34047, 34047, 34047, 34047, 34047, 34047, 34047, 34047,  -- Levels 941-950
        35511, 35511, 35511, 35511, 35511, 35511, 35511, 35511, 35511, 35511,  -- Levels 951-960
        37038, 37038, 37038, 37038, 37038, 37038, 37038, 37038, 37038, 37038,  -- Levels 961-970
        38630, 38630, 38630, 38630, 38630, 38630, 38630, 38630, 38630, 38630,  -- Levels 971-980
        40292, 40292, 40292, 40292, 40292, 40292, 40292, 40292, 40292, 40292,  -- Levels 981-990
        42024, 42024, 42024, 42024, 42024, 42024, 42024, 42024, 42024          -- Levels 991-999
    ];
    current_level integer := 1;
    cumulative_xp integer := 0;
    current_xp_in_level integer := 0;
    remaining_xp integer := total_xp;
    xp_needed_for_next integer;
BEGIN
    -- Start from level 1 and work up
    FOR i IN 1..array_length(level_requirements, 1) LOOP
        -- Check if we have enough XP to complete this level
        IF remaining_xp >= level_requirements[i] THEN
            -- We can complete this level
            remaining_xp := remaining_xp - level_requirements[i];
            current_level := current_level + 1;
        ELSE
            -- We're stuck in this level
            current_xp_in_level := remaining_xp;
            xp_needed_for_next := level_requirements[i] - remaining_xp;
            EXIT;
        END IF;
    END LOOP;
    
    -- If we've gone through all levels, cap at max level
    IF current_level > 999 THEN
        current_level := 999;
        current_xp_in_level := 0;
        xp_needed_for_next := 0;  -- Max level reached
    END IF;
    
    RETURN QUERY SELECT current_level, current_xp_in_level, COALESCE(xp_needed_for_next, 0);
END;
$$;

-- Step 2: Grant permissions
-- ========================

GRANT EXECUTE ON FUNCTION public.calculate_level_from_xp_new(integer) TO anon, authenticated, service_role;

-- Step 3: Test the function
-- ========================

DO $$
DECLARE
    test_result RECORD;
BEGIN
    -- Test some key values
    RAISE NOTICE '🧪 Testing FIXED level calculation:';
    
    -- Test 0 XP (should be level 1, needs 651 to reach level 2)
    SELECT * INTO test_result FROM public.calculate_level_from_xp_new(0);
    RAISE NOTICE '  0 XP: Level %, Current: %, To Next: %', test_result.level, test_result.current_level_xp, test_result.xp_to_next;
    
    -- Test 650 XP (should be level 1, needs 1 more to reach level 2)
    SELECT * INTO test_result FROM public.calculate_level_from_xp_new(650);
    RAISE NOTICE '  650 XP: Level %, Current: %, To Next: %', test_result.level, test_result.current_level_xp, test_result.xp_to_next;
    
    -- Test 651 XP (should be level 2, needs 651 more to reach level 3)
    SELECT * INTO test_result FROM public.calculate_level_from_xp_new(651);
    RAISE NOTICE '  651 XP: Level %, Current: %, To Next: %', test_result.level, test_result.current_level_xp, test_result.xp_to_next;
    
    -- Test 1302 XP (should be level 3, needs 651 more to reach level 4)
    SELECT * INTO test_result FROM public.calculate_level_from_xp_new(1302);
    RAISE NOTICE '  1302 XP: Level %, Current: %, To Next: %', test_result.level, test_result.current_level_xp, test_result.xp_to_next;
    
    RAISE NOTICE '✅ Level calculation system FIXED!';
    RAISE NOTICE '✅ Users can now level up properly!';
    RAISE NOTICE '✅ XP requirements are fixed and never change!';
END $$;